# 产品分析计算逻辑文档

## 1. 数据预处理

### 1.1 基础数据准备
- 项目名称（project_name）
- 报表日期范围（report_start_date, report_end_date）
- 文件处理：
  * 业务报告（Business Report）
  * 付款报告（Payment Report）
  * 待处理付款报告（Payment Report Hold）
  * 广告产品报告（AD Product Report）
  * 基础信息报告（Basic Information）

### 1.2 SKU-ASIN 映射处理
1. 从基础信息报告中提取 SKU-ASIN 映射
2. 从广告数据中提取补充的 SKU-ASIN 映射
3. 合并并去重，确保每个 SKU 对应唯一的 ASIN

## 2. 数据计算流程

### 2.1 广告数据处理
```
广告基础指标：
- 广告展示量（直接获取）
- 广告点击量（直接获取）
- 广告花费（直接获取，保留2位小数）
- 广告销售额（直接获取，保留2位小数）
- 广告订单量（直接获取，转为整数）

广告计算指标：
- 广告点击率 = 广告点击量 / 广告展示量
- 广告单占比 = 广告订单量 / 实际销售量
- 广告转化率 = 广告订单量 / 广告点击量
- CPC = 广告花费 / 广告点击量
- ACOS = 广告花费 / 广告销售额
- SP占比 = 广告花费 / 实际销售额
```

### 2.2 Payment数据处理
```
销售数据计算：（筛选 Order，计算付款报告-销售额，可能包含 Refund）
- 实际销售额 = product sales + shipping credits + promotional rebates
- 实际销售量 = quantity (销售订单)

退款数据计算：（筛选 Refund，计算付款报告-退款额, 同订单可能在 Order 和 Refund 中都有）
- 实际退款额 = product sales + shipping credits + promotional rebates + other
- 实际退款量 = quantity (退款订单)

费用计算：
- 平台佣金 = selling fees
- FBA配送费 = fba fees
- 产品FOB = 实际销售量 * FOB单价
- 销售头程 = 实际销售量 * 头程单价
```

### 2.3 业务报告数据处理
```
基础指标：
- 页面浏览量（直接获取，去除逗号并转为数值）
- 总访客数（直接获取，去除逗号并转为数值）
- 总销量（直接获取）
- 总销售额（去除货币符号和逗号，转为浮点数）

计算指标：
- 总转化率 = 总销量 / 页面浏览量
- 自然流量 = 页面浏览量 - 广告点击量
- 自然流量占比 = 自然流量 / 页面浏览量
- 自然单量 = 总销量 - 广告订单量
- 自然单转化率 = 自然单量 / 自然流量
```

### 2.4 综合指标计算
```
成本相关指标：
- 成本占比 = 产品FOB / 实际销售额
- 头程占比 = 销售头程 / 实际销售额
- 配送费占比 = FBA配送费 / 实际销售额
- 佣金占比 = 平台佣金 / 实际销售额
- 总成本 = 产品FOB + 销售头程 + FBA配送费 + 平台佣金
- 总成本占比 = 总成本 / 实际销售额

利润相关指标：
- 利润 = 实际销售额 - 总成本 - 广告花费 - 实际退款额
- 利润率 = 利润 / 实际销售额

其他关键指标：
- 平均售价 = 实际销售额 / 实际销售量
- 退款率 = 实际退款额 / 实际销售额
```

## 3. 数据处理注意事项

### 3.1 零值处理
所有涉及除法的计算都需要处理分母为零的情况：
- 当分母为零时，结果默认设置为0
- 使用 numpy.where() 进行条件处理

### 3.2 数据类型转换
- 金额相关数据保留2位小数
- 数量相关数据转换为整数
- 比率类数据转换为4位小数

### 3.3 数据清洗
- 移除数值中的货币符号（如 US$）
- 移除数字中的逗号分隔符
- 处理空值（使用0填充）
- 标准化日期格式

## 4. 输出文件处理

### 4.1 Excel模板应用
- 使用预定义的Excel模板
- 应用单元格样式（边框、对齐方式）
- 设置数值格式（百分比、小数位数）

### 4.2 文件命名规则
- 格式：{project_name}_product_analysis_{YYYYMMDD-MMDD}.xlsx
- 包含项目名称和日期范围信息

### 4.3 文件保存路径
- 主文件保存在项目的"产品数据分析"目录
- 临时文件保存在项目的"tmp"目录

## 5. 异常处理
- 检查必要文件是否存在
- 验证文件格式是否正确
- 处理日期格式转换异常
- 处理数值转换异常
